name: Python validation

on:
  push:
  pull_request:

jobs:
  validate-python-deps:
    runs-on: ubuntu-latest
    env:
      SKIP_CACHE: ""   # keep if you reference it elsewhere
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-tools
        run: python -m pip install --upgrade pip pip-tools

      # (1) Fetch the single-module logging framework into src/common/
      - name: Fetch python_logging_framework
        run: |
          mkdir -p src/common
          curl -sSLo src/common/python_logging_framework.py \
            https://raw.githubusercontent.com/manoj-bhaskaran/My-Scripts/main/src/common/python_logging_framework.py

      # Expose src on PYTHONPATH so imports can resolve during subsequent steps (if any)
      - name: Expose src on PYTHONPATH
        run: echo "PYTHONPATH=$PWD/src" >> $GITHUB_ENV

      # (last) Validate deps while skipping Windows-only editables that break Linux runners
      - name: Validate deps (skip Windows-only editables)
        id: validate_deps
        shell: bash
        run: |
          set +e
          awk '!/^-e[[:space:]]+([A-Za-z]:|file:|\\\\)/ && !/D:\\\\My Scripts/' requirements.txt \
          | pip-compile --dry-run - -o requirements.out
          status=$?

          if [ $status -eq 0 ]; then
            echo "::debug::Python validate no broken dependencies"
            echo "valid-project=true" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "valid-project=false" >> "$GITHUB_OUTPUT"
            {
              echo "### :warning: Python validation failed in repository root"
              echo "We were unable to validate a Python project in the repository root. If your repository requires additional setup steps, you may need to check in your own workflow."
              echo ""
              echo "For more information on submitting Python dependencies from your own workflow, refer to [the submission action](https://github.com/actions/component-detection-dependency-submission-action)"
            } >> "$GITHUB_STEP_SUMMARY"
            echo "::warning::Python validation failed in the repository root."
            exit 1
          fi
